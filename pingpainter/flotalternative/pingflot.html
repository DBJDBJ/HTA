<!DOCTYPE html >
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flotinger = Flot + Pinger</title>
	<link href="examples.css" rel="stylesheet" type="text/css">
</head>
<body>
	<div id="header" class="bordered">
		<h2>Flotinger = Flot + Pinger</h2>
        <p id="start_button" class="bttn" >Waiting ...</p>
		<p id="ping_time">Last ping response time: 0</p>
    </div>
	<div id="content" class="demo-container bordered" >
		<div id="placeholder" class="demo-container bordered"></div>
		<p>You can update a chart periodically to get a real-time effect by using a timer to insert the new data in the plot and redraw it.</p>
		<p>Remote thing to ping (IP or domain name): <input id="remote_adrs" type="text" value="http://orig01.deviantart.net/92d3/f/2010/110/7/2/pla_sf_3_by_recon071.jpg" style="text-align: left; width:100%"></p>
		<p>Time between updates: <input id="updateInterval" type="text" value="" style="text-align: right; width:5em"> milliseconds</p>
	</div>
	<div id="footer" class="bordered">
		Copyright &copy; 2007 - 2014 IOLA and Ole Laursen
	</div>
</body>
    <script type="text/javascript" src="../js/jquery.min.js"></script>
    <script type="text/javascript" src="dbj.microlib.min.js"></script>
	<script type="text/javascript" src="jquery.flot.js"></script>
    <script type="text/javascript" src="jquery.flot.threshold.js"></script>
	<script type="text/javascript" src="ping.js"></script>
	<script type="text/javascript">

	if ( ! dbj ) {
	    alert("dbj must be an object at this point");
		debugger;		
	}

    /**
	  How many ticks can be squeezed in one milisecond on this machine?
	  Is this a cludge or not I am not sure. It works in any case.
	 */	
	function tick_meter (max, rezult_cb) {

	var t1 = (new Date()) - 0, timer = null, rez = [] ;

	function tickpersec ( time_point  ) {
		 rez.push(time_point - t1) ;
		 if ( rez.length > max ) { clearTimeout(timer); timer = null ; 
			  rezult_cb( parseInt( eval(rez.join("+")) / rez.length ) ); 
		 }
		 t1 = time_point;   
	}

	timer = setInterval( function () {
			tickpersec.call( tick_meter, +(new Date())) ;
	}, 1 );

}

/*
* Called when all is well
*/
function page_ready ( tick_per_milisec_avg ) {


	    var data = [], totalPoints = 300, data_pointer_ = 0 ,
	        
	        data_pointer = function () {
	            return data_pointer_ > totalPoints ? data_pointer_ = 0 : data_pointer_++;
	        };

			
		/**
		http://stackoverflow.com/questions/4959975/generate-random-value-between-two-numbers-in-javascript
		*/
		function randomIntFromInterval(min,max)
		{
			return Math.floor(Math.random()*(max-min+1)+min);
		}
		/* */
		function createRandomData( min_y, max_y ) {

		    var retval = [], prev = 0 ;
		    retval[0] = parseInt(max_y / 2);
			var y;
			// Do a random walk
			while (retval.length < totalPoints) {
			   prev = retval[retval.length - 1];
			    // y = retval[retval.length - 1] + Math.random() * 10 - 5;
				// y = dbj.keep_inside(y, [0, max_y]);
				retval.push( randomIntFromInterval(min_y,max_y));
			}

			// index the generated y values with the x values
			for (var x = 0; x < retval.length; ++x) {
			    retval[x] = [x, retval[x]];
			}
			    return retval; 
		}
		/* */

		// Set up the control widget
		var updateInterval = 30;
		$("#updateInterval").val(updateInterval).change(function () {
			var v = $(this).val();
				updateInterval = dbj.keep_inside(v, [1, 2000]);
			$(this).val("" + updateInterval);
		});

		function createPlotWithOptions(d1, t) {
		    return $.plot("#placeholder", [d1], // eof data 
            {
				color: "rgb(30, 180, 20)",
		        threshold: {
		            below: t,
		            color: "rgb(200, 20, 30)"
		        },
                lines: {
                    steps: true
                },
                series: {
                    shadowSize: 0,	// Drawing is faster without shadows
                },
                grid: {
                    clickable: false,
                    hoverable: false
                },
                yaxis: {
                    min: 350, max: 400
                },
                xaxis: { show: false }
            }  // eof options
            );
		}

		
		function update(data_index, last_ping_value ) {

			last_ping_value = dbj.keep_inside(
		    parseInt( 
			last_ping_value / tick_per_milisec_avg ), // how many milsec is this
			[350,400]
			) ;
			
		    data[data_index] = [data_index, last_ping_value]; // create 2D point
		    $("#ping_time").text(
					"Ping : {0}".format(data[data_index].join(" , time: "))
			);
			plot.setData( [data] );
			// plot.setupGrid();
			plot.draw();
		}


		var plot_timer = null ;
		
		var plot = createPlotWithOptions(data = createRandomData(350,400), 100);

		window.start = function (  ) {

			$("#start_button").text("Stop");

            if ( plot_timer != null ) {
				clearTimeout(plot_timer); plot_timer = null; return false;
				parent_element.innerText = "Start";
            }

			var remote = $("#remote_adrs").val();

			plot_timer = setInterval(
			function (){
					collect_ping_data(remote, data_pointer(), update )
				
		    }, 
			updateInterval);
		};
		
		$("#start_button")
		        .off("click")
                .click(function () { start( ); })
                .text("Start");
		
		// Add the Flot version string to the footer
		$("#footer").prepend("Flot " + $.plot.version + " &ndash; ");
	} ;

        //--------------------------------------
		onload = function () {
		
		try {
		    $("#start_button").text("Preparing...");
			tick_meter( 10, function ( tpm_avg ) {
						page_ready( tpm_avg );
				});
			} catch (x) {
				dbj.print( dbj.err2str(x));
			}
		}

</script>
</html>
